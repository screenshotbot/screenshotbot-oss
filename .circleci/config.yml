version: 2.1

jobs:
  build:
    docker:
      - image: debian:bookworm
    steps:
      - checkout
      - run: &install_deps
          name: Install Deps
          command: apt-get update && apt-get install -y imagemagick build-essential openjdk-17-jdk-headless sbcl libmagickwand-dev libssh2-1-dev ssh git sudo
      - run:
          name: SBCL tests
          command: |
            for dir in /usr/lib/x86_64-linux-gnu/ImageMagick-*/bin-q* ; do
                export PATH=$PATH:$dir
            done
            echo $PATH
            which MagickWand-config
            dpkg -S MagickWand-config
            make test-sb
      - run:
          name: build-cli
          command: |
            sbcl --script scripts/build-cli.lisp

      - run:
          name: Upload assets for Screenshots
          command: |
            make upload-screenshots-oss

  launch:
    docker:
      - image: cimg/base:2021.04
    steps:
      - checkout
      - run:
          <<: *install_deps
      - run:
          name: Launch Screenshotbot
          command: |
            mkdir -p ~/.config/screenshotbot/object-store/current/
            sbcl --script launch.lisp --verify-store

  build_cli:
    docker:
      - image: cimg/base:2021.04
    steps:
      - checkout
      - run:
          <<: *install_deps
      - run:
          name: Build CLI
          command: |
            sbcl --script scripts/build-cli.lisp


workflows:
  tests:
    jobs:
      - build
  launch:
    jobs:
      - launch
  build_cli:
    jobs:
      - build_cli
